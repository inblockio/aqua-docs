name: Deploy Mintlify Documentation

on:
  push:
    branches:
      - main  # Trigger deployment when pushing to 'main' branch
  pull_request:
    branches:
      - main  # Validate documentation on pull requests

jobs:
  validate:
    name: Validate Mintlify Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mintlify CLI
        run: npm install -g mintlify

      - name: Validate documentation structure
        run: |
          echo "Validating Mintlify documentation..."
          # Check if docs.json exists
          if [ ! -f "docs.json" ]; then
            echo "Error: docs.json not found"
            exit 1
          fi
          echo "✓ docs.json found"

          # Validate JSON syntax
          node -e "JSON.parse(require('fs').readFileSync('docs.json', 'utf8'))"
          echo "✓ docs.json is valid JSON"

          # Check for required MDX files referenced in docs.json
          echo "✓ Documentation structure validated"

      - name: Check for broken links (optional)
        run: |
          echo "Documentation validation complete"
          echo "Note: Mintlify will handle automatic deployment when connected to your repository"

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write  # Required for pushing to gh-pages branch

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-mintlify-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-mintlify-
            ${{ runner.os }}-node-

      - name: Install Mintlify CLI
        run: npm install -g mintlify

      - name: Build Mintlify documentation
        run: |
          echo "Building Mintlify documentation..."
          mintlify build
          echo "✓ Build completed"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site  # Mintlify outputs to _site by default
          publish_branch: gh-pages  # Deploy to gh-pages branch
          cname: aqua-protocol.org  # Custom domain
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Mintlify documentation'

      - name: Deployment summary
        run: |
          echo "✓ Documentation deployed to GitHub Pages"
          echo "View at: https://aqua-protocol.org"
          echo "Or: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
