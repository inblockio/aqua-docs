---
title: "Concepts"
description: "Core concepts and terminology for Aqua Protocol v3"
---

# Aqua Protocol v3 Concepts

Understanding the core concepts of Aqua Protocol v3 is essential for effectively using the SDK and building applications. This guide covers the fundamental ideas, terminology, and patterns used throughout the protocol.

## AquaTree

The **AquaTree** is the primary data structure in v3. It represents a complete, self-contained collection of revisions with their relationships and metadata.

### Structure

```typescript
interface AquaTree {
  revisions: Revisions      // All revisions indexed by hash
  file_index: FileIndex     // Maps file hashes to filenames
  tree?: RevisionTree       // Tree structure of revisions
  treeMapping?: TreeMapping // Path mappings for navigation
}
```

### Components

#### 1. Revisions
A flat map of all revisions, keyed by their verification hash:

```typescript
{
  "0xabc123...": {
    previous_verification_hash: "0xdef456...",
    local_timestamp: "2024-01-01T12:00:00",
    revision_type: "file",
    // ... other fields
  },
  "0xdef456...": {
    // ... another revision
  }
}
```

#### 2. File Index
Maps file content hashes to filenames for reference:

```typescript
{
  "0xfile_hash_1": "document.pdf",
  "0xfile_hash_2": "image.png"
}
```

#### 3. Tree Structure (Optional)
Hierarchical representation showing parent-child relationships:

```typescript
{
  hash: "0xabc123...",  // Root revision
  children: [
    {
      hash: "0xdef456...",
      children: [...]
    }
  ]
}
```

#### 4. Tree Mapping (Optional)
Path information for each revision:

```typescript
{
  paths: {
    "0xabc123": ["0xroot", "0xabc123"],
    "0xdef456": ["0xroot", "0xabc123", "0xdef456"]
  },
  latestHash: "0xdef456..."  // Most recent revision
}
```

## Revisions

A **Revision** is a single entry in the AquaTree representing an operation or state change.

### Common Fields

All revisions share these base fields:

| Field | Type | Description |
|-------|------|-------------|
| `previous_verification_hash` | string | Hash linking to previous revision (empty string for genesis) |
| `local_timestamp` | string | ISO 8601 timestamp when revision was created |
| `revision_type` | string | One of: `"file"`, `"form"`, `"signature"`, `"witness"`, `"link"` |
| `version` | string | Protocol version with method: `https://aqua-protocol.org/docs/v3/schema_2 \| SHA256 \| Method: scalar/tree` |

### Genesis Revision

The **genesis revision** is the first revision in a chain:
- `previous_verification_hash` is an empty string `""`
- Typically a file or form revision
- Establishes the initial state

### Verification Hash

Each revision has a unique **verification hash** computed from its canonical form:

```typescript
hash = SHA256(canonicalized_revision_data)
```

This hash serves as:
- Unique identifier for the revision
- Key in the revisions map
- Reference in `previous_verification_hash` fields

## Revision Types

### 1. File Revision

Stores file metadata and optionally content.

**Purpose**: Document file presence and content integrity

**Fields**:
- `file_hash`: SHA256 hash of file content
- `file_nonce`: Random nonce for uniqueness
- `content`: Optional file content (text or binary)
- `leaves`: Array of hashes (tree mode only)

**Example**:
```json
{
  "previous_verification_hash": "",
  "local_timestamp": "2024-01-01T12:00:00",
  "revision_type": "file",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar",
  "file_hash": "0x9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08",
  "file_nonce": "0x3fa8b1c2d3e4f5a67b8c9d0e1f2a3b4c"
}
```

### 2. Form Revision

Stores structured key-value data.

**Purpose**: Capture form submissions, structured data, or metadata

**Fields**:
- `file_hash`: Hash of form data
- `file_nonce`: Random nonce
- `content`: Form data as key-value object
- `leaves`: Array of hashes (tree mode only)

**Example**:
```json
{
  "previous_verification_hash": "",
  "local_timestamp": "2024-01-01T12:00:00",
  "revision_type": "form",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: tree",
  "file_hash": "0xabc123...",
  "file_nonce": "0x123abc...",
  "content": {
    "name": "John Doe",
    "email": "john@example.com",
    "status": "approved"
  },
  "leaves": ["0x...", "0x...", "0x..."]
}
```

### 3. Signature Revision

Adds cryptographic signature to prove authenticity.

**Purpose**: Authenticate revisions and establish authorship

**Fields**:
- `signature`: Signature value (format depends on type)
- `signature_type`: One of `"cli"`, `"metamask"`, `"did"`, `"p12"`, `"inline"`
- `signature_wallet_address`: Ethereum address (for cli/metamask)
- `signature_public_key`: Public key (for p12)

**Example (MetaMask)**:
```json
{
  "previous_verification_hash": "0xabc123...",
  "local_timestamp": "2024-01-01T12:01:00",
  "revision_type": "signature",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar",
  "signature_type": "metamask",
  "signature": "0x8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f...",
  "signature_wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb8"
}
```

**Example (DID)**:
```json
{
  "previous_verification_hash": "0xabc123...",
  "local_timestamp": "2024-01-01T12:01:00",
  "revision_type": "signature",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar",
  "signature_type": "did",
  "signature": {
    "payload": "eyJhbGciOi...",
    "signatures": [{
      "protected": "eyJhbGci...",
      "signature": "..."
    }]
  }
}
```

### 4. Witness Revision

Anchors revision to external timestamping service.

**Purpose**: Prove existence at specific time via blockchain or TSA

**Fields**:
- `witness_merkle_root`: Root hash of Merkle tree
- `witness_timestamp`: Unix timestamp from witness service
- `witness_network`: Network used (`"mainnet"`, `"sepolia"`, `"holesky"`, `"tsa"`, `"nostr"`)
- `witness_smart_contract_address`: Contract address (Ethereum)
- `witness_transaction_hash`: Transaction hash
- `witness_sender_account_address`: Account that witnessed
- `witness_merkle_proof`: Merkle proof array

**Example (Ethereum)**:
```json
{
  "previous_verification_hash": "0xabc123...",
  "local_timestamp": "2024-01-01T12:02:00",
  "revision_type": "witness",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar",
  "witness_merkle_root": "0xdef456...",
  "witness_timestamp": 1704110520,
  "witness_network": "sepolia",
  "witness_smart_contract_address": "0x5FbDB2315678afecb367f032d93F642f64180aa3",
  "witness_transaction_hash": "0x9f86d081...",
  "witness_sender_account_address": "0x742d35Cc...",
  "witness_merkle_proof": []
}
```

### 5. Link Revision

Connects to other AquaTree chains.

**Purpose**: Establish relationships between separate chains

**Fields**:
- `link_type`: Type of link relationship (application-specific)
- `link_verification_hashes`: Array of hashes from other chains
- `link_file_hashes`: Array of corresponding file hashes

**Example**:
```json
{
  "previous_verification_hash": "0xabc123...",
  "local_timestamp": "2024-01-01T12:03:00",
  "revision_type": "link",
  "version": "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar",
  "link_type": "dependency",
  "link_verification_hashes": [
    "0x111...",
    "0x222...",
    "0x333..."
  ],
  "link_file_hashes": [
    "0xaaa...",
    "0xbbb...",
    "0xccc..."
  ]
}
```

## Methods: Scalar vs Tree

V3 supports two canonicalization methods, specified in the version string.

### Scalar Method

**Format**: `Method: scalar`

**How it works**:
- Revision is serialized as-is
- Hash computed directly from canonical JSON
- Simple, straightforward

**When to use**:
- Small revisions
- Simple file/form data
- Quick operations

**Example**:
```typescript
version: "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: scalar"
// No leaves field
```

### Tree Method

**Format**: `Method: tree`

**How it works**:
- Content broken into key-value leaves
- Each leaf hashed individually
- Merkle tree constructed from leaves
- Root becomes the verification hash

**When to use**:
- Large files or forms
- Selective disclosure needed
- Proof of specific fields

**Example**:
```typescript
version: "https://aqua-protocol.org/docs/v3/schema_2 | SHA256 | Method: tree"
leaves: [
  "0xhash_of_key_value_1",
  "0xhash_of_key_value_2",
  "0xhash_of_key_value_3"
]
```

**Leaf Generation**:
```typescript
// For form data: { "name": "John", "email": "john@example.com" }
leaves = [
  SHA256("name:John"),
  SHA256("email:john@example.com")
]
```

## Chains and Trees

### Linear Chain

Simple sequence of revisions:

```
Genesis ï¿½ Signature ï¿½ Witness ï¿½ Update ï¿½ Signature ï¿½ Witness
```

Each revision references the previous one.

### Branching Tree

Multiple paths from a common ancestor:

```
            Genesis
               ï¿½
          Signature
             /  \
        Branch A  Branch B
           ï¿½        ï¿½
        Update 1  Update 2
```

V3 supports branching, allowing parallel development paths.

### Path Mapping

The `treeMapping` provides paths to each revision:

```typescript
{
  paths: {
    "genesis_hash": ["genesis_hash"],
    "sig_hash": ["genesis_hash", "sig_hash"],
    "branch_a_hash": ["genesis_hash", "sig_hash", "branch_a_hash"],
    "branch_b_hash": ["genesis_hash", "sig_hash", "branch_b_hash"]
  },
  latestHash: "branch_a_hash"  // Longest path
}
```

## File Object

Input format for creating revisions:

```typescript
interface FileObject {
  fileName: string           // Display name
  fileContent: string |      // Text content
                AquaTree |   // Linked tree
                Uint8Array | // Binary data
                Record<string, string> | // Form data
                object       // Structured data
  path: string              // File path
  fileSize?: number         // Size in bytes
}
```

### Content Types

**Text**: Plain text, HTML, JSON
```typescript
{
  fileName: "doc.txt",
  fileContent: "Hello World",
  path: "/docs/doc.txt"
}
```

**Binary**: Images, PDFs, any binary file
```typescript
{
  fileName: "image.png",
  fileContent: new Uint8Array([...]),
  path: "/images/image.png"
}
```

**Form**: Key-value structured data
```typescript
{
  fileName: "form.json",
  fileContent: {
    "field1": "value1",
    "field2": "value2"
  },
  path: "/forms/form.json"
}
```

**Link**: Reference to another AquaTree
```typescript
{
  fileName: "linked.json",
  fileContent: anotherAquaTree,
  path: "/links/linked.json"
}
```

## Verification Graph

Result of verification includes a graph structure:

```typescript
interface VerificationGraphData {
  hash: string
  previous_verification_hash: string
  timestamp: string
  isValidationSuccessful: boolean
  revisionType: RevisionType
  info: RevisionGraphInfo  // Type-specific details
  verificationGraphData: VerificationGraphData[]      // Children
  linkVerificationGraphData: VerificationGraphData[]  // Links
}
```

### Traversing the Graph

```typescript
function printVerification(graph: VerificationGraphData, depth = 0) {
  const indent = "  ".repeat(depth);
  const status = graph.isValidationSuccessful ? "" : "";
  console.log(`${indent}${status} ${graph.revisionType} (${graph.hash.slice(0, 10)}...)`);

  // Traverse children
  graph.verificationGraphData.forEach(child => {
    printVerification(child, depth + 1);
  });

  // Traverse links
  graph.linkVerificationGraphData.forEach(link => {
    console.log(`${indent}  ï¿½ Linked:`);
    printVerification(link, depth + 2);
  });
}
```

## Credentials

Configuration for signing and witnessing:

```typescript
interface CredentialsData {
  mnemonic: string             // BIP39 mnemonic for CLI signing
  nostr_sk: string             // Nostr secret key
  did_key: string              // DID key for DID signing
  alchemy_key: string          // Alchemy API key for verification
  witness_eth_network: string  // "mainnet", "sepolia", "holesky"
  witness_method: string       // "cli" or "metamask"
  p12_password?: string        // P12 certificate password
  p12_content?: string         // P12 certificate content
}
```

## Logging

V3 uses typed logging throughout:

```typescript
enum LogType {
  SUCCESS = "success",
  INFO = "info",
  ERROR = "error",
  WARNING = "warning",
  HINT = "hint",
  DEBUGDATA = "debug_data",
  // ... revision types with emojis
  FILE = "file",      // =ï¿½
  LINK = "link",      // =
  SIGNATURE = "signature",  // =
  WITNESS = "witness",      // =@
  FORM = "form"            // =ï¿½
}
```

Each operation returns logs for debugging and user feedback.

## Best Practices

### 1. Genesis Patterns

**Single File**:
```
File Genesis ï¿½ Sign ï¿½ Witness
```

**Form Data**:
```
Form Genesis ï¿½ Sign ï¿½ Witness
```

### 2. Update Patterns

**Content Update**:
```
... ï¿½ New File Revision ï¿½ Sign ï¿½ Witness
```

**Multi-Party**:
```
... ï¿½ Sign (Party 1) ï¿½ Sign (Party 2) ï¿½ Witness
```

### 3. Linking Patterns

**Dependencies**:
```
Main Document ï¿½ Link (to dependencies) ï¿½ Sign ï¿½ Witness
```

**Aggregation**:
```
Component 1 
Component 2 ï¿½ Aggregation Link ï¿½ Sign ï¿½ Witness
Component 3 
```

### 4. Verification Patterns

**Full Chain**:
```typescript
const result = await aquafier.verifyRevisionChain(aquaTree);
```

**Specific Revision**:
```typescript
const revision = aquaTree.revisions[specificHash];
// Manually verify hash computation
```

### 5. Storage Patterns

**Database**: Store serialized AquaTree JSON
```typescript
const json = JSON.stringify(aquaTree);
db.save(documentId, json);
```

**File System**: Save as .aqua.json file
```typescript
fs.writeFileSync('document.aqua.json', JSON.stringify(aquaTree, null, 2));
```

## Common Patterns

### Document Lifecycle

```
1. Create ï¿½ File Genesis
2. Review ï¿½ Sign (Reviewer)
3. Approve ï¿½ Sign (Approver)
4. Timestamp ï¿½ Witness (Ethereum)
5. Archive ï¿½ Store AquaTree
6. Verify ï¿½ Check entire chain
```

### Multi-Document Project

```
1. Create each document ï¿½ Individual AquaTrees
2. Link together ï¿½ Link Revision in main tree
3. Sign project ï¿½ Sign main tree
4. Witness ï¿½ Witness main tree
5. All documents timestamped through link
```

## See Also

- [Introduction](/previous_versions/version_3/introduction) - Overview and quick start
- [Tooling](/previous_versions/version_3/tooling) - SDK API reference
- [Schema Reference](/previous_versions/version_3/schema) - Detailed specifications
